<!DOCTYPE html>

<html lang='ko'>
  <head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css" />
    <meta charset='utf-8' />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <style>
      /* ë‹¬ë ¥ í¬ê¸° ì¡°ì • */
      #calendar {
        width: 80%;    /* í™”ë©´ì˜ 80% í¬ê¸°ë¡œ ì„¤ì • */
        margin: 0 auto; /* ì¤‘ì•™ ì •ë ¬ */
        max-width: 900px; /* ìµœëŒ€ ë„ˆë¹„ë¥¼ 900pxë¡œ ì„¤ì • */
      }
      
      a{
      text-decoration:none
      }
      /* ì¼ìš”ì¼ ë‚ ì§œ: ë¹¨ê°„ìƒ‰ */
		.fc-day-sun a {
		    color: #f25278;
		}
		
		/* í† ìš”ì¼ ë‚ ì§œ: íŒŒë€ìƒ‰ */
		.fc-day-sat a {
		    color: #4d64ff;
		}
		
		.fc-day-mon a{
		    color: #303030;
		}
		
		.fc-day-tue a{
		    color: #303030;
		}
		
		.fc-day-wed a {
		    color: #303030;
		}
		.fc-day-thu a {
		    color: #303030;
		}
		
		.fc-day-fri a {
		    color: #303030;
		}
		
		.fc-button-primary {
		    color: red;
		}
		.schedule-container {
		    display: flex;
		    width: 80%;
		    margin: 0 auto; /* ì¤‘ì•™ ì •ë ¬ */
		    height: 600px;
		    /*border: 1px solid #ddd;*/
		}
		
		.schedule-section {
		    width: 48%;
		    padding: 10px;
		    overflow-y: auto;
		}
		
		.divider {
		    width: 1px;
		    background-color: #ccc;
		    margin: 0 10px;
		}
		
		.schedule-list {
		    list-style: none;
		    padding: 0;
		}
		
		.schedule-list li {
		    padding: 10px;
		    margin-bottom: 5px;
		    border-bottom: 1px solid #eee;
		}
		h2{
			text-align:center;
			font-weight:bold;
		}
		
    </style>
     <script>
        $(document).ready(function () {
            let calendarTag = document.getElementById('calendar'); // full-calendar ìƒì„±
            let calendar = new FullCalendar.Calendar(calendarTag, {
                height: '550px',                        
                expandRows: true,                       
                slotMinTime: '00:00',                  
                slotMaxTime: '23:59',                   

                customButtons: {                        
                    testButton: {
                        text: "í…ŒìŠ¤íŠ¸ë²„íŠ¼"
                    }
                },
                headerToolbar: {                                
                    left: 'prevYear,prev,next,nextYear today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                },
                initialView: 'dayGridMonth',    
                navLinks: true,                 
                editable: true,                
                selectable: true,              
                nowIndicator: true,            
                dayMaxEvents: true,            
                locale: 'ko',                   
                
                eventAdd: function (obj) {      
                    console.log("eventAdd : " + obj);
                },
                eventChange: function (obj) {    
                    console.log("eventChange : " + obj);
                },
                eventRemove: function (obj) {     
                    console.log("eventRemove : " + obj);
                },
                select: function (arg) {         
                    let title = prompt('ì¼ì • ì…ë ¥');
                    if (title) {
                     let isAllDay = arg.allDay ? 1 : 0;  // âœ… í™•ì‹¤í•˜ê²Œ 1 ë˜ëŠ” 0ìœ¼ë¡œ ë³€í™˜
                       let newData = {
				            tdTodo: title, // ê¸°ì¡´ ì˜¤ë¥˜ ìˆ˜ì •
				            tdStart: arg.startStr, // FullCalendarì—ì„œëŠ” startStr ì‚¬ìš©
				            tdEnd: arg.endStr,  // FullCalendarì—ì„œëŠ” endStr ì‚¬ìš©
				            tdAllday: isAllDay
				        };
				        console.log("ì¶”ê°€í•˜ëŠ” ì¼ì • ë°ì´í„°:", newData); // ğŸ” ë””ë²„ê¹…ìš© ë¡œê·¸

                        $.ajax({
                            url: "/addTodo",
                            method: "POST",
                            dataType: "json",
                            data: JSON.stringify(newData),
                            contentType: 'application/json',
                            success:function (data){
                                if(data != null){
				                    calendar.addEvent({
				                        tdId: data.tdId,  // ì´ë²¤íŠ¸ ID ì„¤ì •
				                        tdTodo: data.tdTodo, // ì¼ì • ì œëª© ì„¤ì •
				                        tdStart: data.tdStart,
				                        tdEnd: data.tdEnd,
				                        tdAllday: data.tdAllday == 1,
				                        editable: true
				                    });
				                    console.log(data.tdAllday);
									window.location.reload();  // ì„±ê³µ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                                }
                            }
                        });
                    }
                    calendar.unselect();
                },
                eventClick: function (arg) {
                    if (confirm("ì„ íƒí•œ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        $.ajax({
                            type: "DELETE",
                            url: "/deleteTodo",
                            data: {"tdId" : arg.event.id},
                            success: function (data) {
                                if (data == "success") {
                                    alert("ì‚­ì œí•˜ì˜€ìŠµë‹ˆë‹¤.");
                                    arg.event.remove();
                                }else{
                                    alert("ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤");
                                }
                            }
                        });
                    }
                },
                eventDrop: function(arg) {              
                    let event = {
                        tdId: arg.event.id,
                        tdTodo: arg.event.title,
                        tdStart: arg.event._instance.range.start,
                        tdEnd: arg.event._instance.range.end ? arg.event._instance.range.end : null,
                        tdAllday: arg.event.allDay? 1 : 0
                    };
                    $.ajax({
                        url: '/updateTodo/' + arg.event.id,
                        method: 'PUT',
                        contentType: 'application/json',
                        data: JSON.stringify(event)
                    });
                },
                eventResize: function(arg) {            
                    let event = {
                        tdId: arg.event.id,
                        tdTodo: arg.event.title,
                        tdStart: arg.event._instance.range.start,
                        tdEnd: arg.event._instance.range.end ? arg.event._instance.range.end : null,
                        tdAllday: arg.event.allDay? 1 : 0
                    };
                    $.ajax({
                        url: '/updateTodo/' + arg.event.id,
                        method: 'PUT',
                        contentType: 'application/json',
                        data: JSON.stringify(event)
                    });
                },
                // ì´ë²¤íŠ¸
		        events: [
		            $.ajax({
		                type: "get",
		                url: "/todoData",
		                success: function (data) {
		                 console.log("ë¶ˆëŸ¬ì˜¨ ì¼ì • ë°ì´í„°:", data); // âœ… data ì‚¬ìš©
		                    if (data != null) {
		                        for (let i = 0; i < data.length; i++) {
			                        let progress = data[i].tdStatus; // ì§„í–‰ë„ ê°’ ('N', 'P', 'Y')
	                				let eventColor = getEventColor(progress); // ì§„í–‰ë„ì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
		                            calendar.addEvent({
		                                id: data[i].tdId,
		                                title: data[i].tdTodo,
		                                start: data[i].tdStart,
		                                end: data[i].tdEnd,
		                                allDay: data[i].tdAllday,
		                                editable: true,// default : false ì´ë²¤íŠ¸ ë“œë˜ê·¸ ë“±ì˜ í¸ì§‘ì—¬ë¶€ë¥¼ ì„¤ì •í•¨
		                                color: eventColor // ìƒ‰ìƒ ì ìš©
		                            })
		                        }
		                    }
		                },
						error: function(xhr, status, error) {
				        console.log("AJAX ìš”ì²­ ì‹¤íŒ¨:", status, error);  // ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ ì¶œë ¥
				        }
		            })
		        ]
		    });
		    
		    function getEventColor(progress) {
			    if (progress === 'Y') return "#28a745"; // ì™„ë£Œ (ì´ˆë¡ìƒ‰)
			    if (progress === 'P') return "#fd7e14"; // ìˆ˜í–‰ ì¤‘ (ì£¼í™©ìƒ‰)
			    return "#53baf5"; // ìˆ˜í–‰ ì•ˆ í•¨ (íŒŒë€ìƒ‰)
			}
            // ìº˜ë¦°ë” ë Œë”ë§
            calendar.render();
        });
    </script>
  </head>
  <body>
  	<div th:replace="~{board/menu}"></div>
  	<br>
    <div id='calendar'></div>
    <br>
    <div class="schedule-container">
    <br>
    <!-- íŒ€ì› ì¼ì • -->
    
    <div class="schedule-section">
        <h2>íŒ€ì› ì¼ì •</h2>
        <table class="board_list">
         <colgroup>
            <col width="15%"/>
            <col width="*"/>
            <col width="20%"/>
            <col width="15%"/>
         </colgroup>
         <thead>
            <tr>
               <th scope="col">ì´ë¦„</th>
               <th scope="col">ë‚´ìš©</th>
               <th scope="col">ë§ˆê°ì¼</th>
               <th scope="col">ìƒíƒœ</th>
            </tr>
         </thead>
         <tbody>
		    <tr th:each="todo : ${todoList}">
		        <td th:text="${todo.tdWorkM}"></td>
		        <td class="title" th:text="${todo.tdTodo}"></td>
		        <td th:text="${todo.tdEnd != null ? #temporals.format(todo.tdEnd, 'yyyy-MM-dd HH:mm:ss') : '-'}"></td>
		    	<td th:text="${todo.tdStatus}"></td>
		    </tr>
		    <tr th:if="${#lists.isEmpty(todoList)}">
		        <td colspan="4">ì•„ì§ ê³µìœ ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</td>
		    </tr>
		</tbody>
      </table>
        
    </div>
    
    <!-- ê°€ìš´ë° êµ¬ë¶„ì„  -->
    <div class="divider"></div>

    <!-- ê°œì¸ ì¼ì • -->
    <div class="schedule-section">
        <h2>ë¯¸ìˆ˜í–‰ëœ ê°œì¸ ì¼ì •</h2>
        <form action="#" method="post">
        <table class="board_list">
        	<colgroup>
	            <col width="15%"/>
	            <col width="*"/>
	            <col width="15%"/>
	            <col width="15%"/>
         	</colgroup>
         	<thead>
            	<tr>
	               <th scope="col">ë‚´ìš©</th>
	               <th scope="col">ë§ˆê°ì¼</th>
	               <th scope="col">ìƒíƒœ</th>
	               <th scope="col"></th>
            	</tr>
         	</thead>
         	<tbody>
	         	<tr th:each="todo : ${todoList}" th:if="${todo.tdStatus == 'N' or todo.tdStatus == 'P'}">
			        <td class="title" th:text="${todo.tdTodo}"></td>
			        <td th:text="${todo.tdEnd != null ? #temporals.format(todo.tdEnd, 'yyyy-MM-dd HH:mm:ss') : '-'}"></td>
			    	<td th:text="${todo.tdStatus}"></td>
			    	<td> <input type="checkbox" name="todoId" th:value="${todo.tdId}"></td>
			    </tr>
			    <tr th:if="${#lists.isEmpty(todoList)}">
			        <td colspan="4">ì•„ì§ ê³µìœ ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</td>
			    </tr>
         	</tbody>
        </table>
        	<input type="button" value="ìˆ˜í–‰ì¤‘">
         	<input type="button" value="ì™„ë£Œ">
         	<input type="button" value="ê³µìœ ">
         	<input type="button" value="ê³µìœ ì·¨ì†Œ">
        </form>
    </div>
</div>
    <div th:replace="~{board/footer}"></div>
  </body>
</html>
